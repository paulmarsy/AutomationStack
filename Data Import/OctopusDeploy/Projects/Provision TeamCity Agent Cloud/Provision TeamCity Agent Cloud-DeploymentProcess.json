{
  "$type": "Octopus.Core.Model.Projects.DeploymentProcess, Octopus.Core",
  "Id": "deploymentprocess-Projects-8",
  "OwnerId": "Projects-8",
  "Version": 77,
  "Steps": [
    {
      "Id": "960b4de1-2296-4d97-b547-def57ea373fa",
      "Name": "Download DSC Configuration",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "1173c03f-ded0-433b-b85f-cb8ee9ccab30",
          "Name": "Download DSC Configuration",
          "ActionType": "Octopus.Script",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.RunOnServer": "true",
            "Octopus.Action.Script.ScriptFileName": "Copy-AzureFileShare.ps1",
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Storage",
            "Octopus.Action.Script.ScriptParameters": "-StorageAccountName '#{StorageAccountName}' -StorageAccountKey '#{StorageAccountKey}' -FileShareName '#{FileShareName}' -LocalPath '#{LocalPath}'",
            "Octopus.Action.Template.Id": "ActionTemplates-5",
            "Octopus.Action.Template.Version": "2",
            "StorageAccountName": "#{StorageAccountName}",
            "StorageAccountKey": "#{StorageAccountKey}",
            "LocalPath": "#{DSCConfigPath}",
            "FileShareName": "dsc"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "Azure Automation"
      }
    },
    {
      "Id": "4ec43535-5518-42fe-90a3-5cf542e79328",
      "Name": "Import DSC Configuration",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "89ca9f5f-f7e7-4cce-838c-c6b8331fda9e",
          "Name": "Import DSC Configuration",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Script.ScriptFileName": "Import-TeamCityConfig.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Automation",
            "Octopus.Action.Script.ScriptParameters": "-Path '#{Path}' -InfraRg '#{InfraRg}' -AutomationAccountName '#{AutomationAccountName}' -OctopusServerUrl '#{OctopusHostHeader}' -OctopusApiKey '#{APIKey}' -HostHeader '#{TeamCityHostHeader}' -TeamCityVersion '#{TeamCityVersion}'",
            "Path": "#{DSCConfigFile}",
            "TeamCityVersion": "#{TeamCityVersion}",
            "Octopus.Action.Template.Id": "ActionTemplates-7",
            "Octopus.Action.Template.Version": "6"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "Azure Automation"
      }
    },
    {
      "Id": "6ea370e7-796b-4d7d-b5ae-4cdf1f1025e1",
      "Name": "Create Resource Group",
      "Condition": "Success",
      "StartTrigger": "StartWithPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "2cb1274b-c27e-4372-a0e1-536de71fd578",
          "Name": "Create Resource Group",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Script.ScriptFileName": "New-ResourceGroup.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Resources",
            "Octopus.Action.Script.ScriptParameters": "-UDP '#{UDP}' -ResourceGroupName '#{ResourceGroupName}' -Location '#{Location}'",
            "ResourceGroupName": "#{ResourceGroup}",
            "Location": "#{AzureRegion}",
            "Octopus.Action.Template.Id": "ActionTemplates-11",
            "Octopus.Action.Template.Version": "7"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "ARM Provisioning"
      }
    },
    {
      "Id": "29dcf8e4-c64a-4d66-b57e-d710ba06ce47",
      "Name": "Provision Windows Server 2016 VM",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "7e82a6aa-92f8-461e-8891-0539e14d3db3",
          "Name": "Provision Windows Server 2016 VM",
          "ActionType": "Octopus.AzureResourceGroup",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Azure.ResourceGroupName": "#{ResourceGroupName}",
            "Octopus.Action.Azure.TemplateSource": "Package",
            "Octopus.Action.Azure.ResourceGroupTemplateParameters": "OctopusDeploy\\agentserver.parameters.json",
            "Octopus.Action.Azure.ResourceGroupDeploymentMode": "Complete",
            "Octopus.Action.Azure.ResourceGroupTemplate": "agentserver.json",
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Package.PackageId": "ARMTemplates",
            "ProductName": "#{ProductName}",
            "ResourceGroupName": "#{ResourceGroup}",
            "Octopus.Action.Template.Id": "ActionTemplates-1",
            "Octopus.Action.Template.Version": "2",
            "NodeConfigurationName": "#{DSCConfigurationName}.#{DSCNodeName}"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "ARM Provisioning"
      }
    },
    {
      "Id": "311a11b7-2c53-4be6-8203-469a3e82ec2f",
      "Name": "Wait for DSC Node Compliance",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "478e3758-8cfe-4d33-9ebd-d171a94ac7b5",
          "Name": "Wait for DSC Node Compliance",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Script.ScriptFileName": "Invoke-CustomScript.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Compute",
            "Octopus.Action.Script.ScriptParameters": "-Name '#{Name}' -ResourceGroupName '#{ResourceGroupName}' -VMName '#{VMName}' -Location '#{Location}' -StorageAccountName '#{StorageAccountName}' -StorageAccountKey '#{StorageAccountKey}'",
            "ResourceGroupName": "#{ResourceGroup}",
            "VMName": "#{VMName}",
            "Name": "AutomationNodeCompliance",
            "Location": "#{AzureRegion}",
            "StorageAccountName": "#{StorageAccountName}",
            "StorageAccountKey": "#{StorageAccountKey}",
            "Octopus.Action.Template.Id": "ActionTemplates-9",
            "Octopus.Action.Template.Version": "4"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "Azure Automation"
      }
    },
    {
      "Id": "e90df294-20cc-4f5f-974c-9765296ec252",
      "Name": "Run Sysprep",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "abf4faeb-71e0-4f31-971b-d4230ab86f78",
          "Name": "Run Sysprep",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Script.ScriptFileName": "Invoke-CustomScript.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Compute",
            "Octopus.Action.Script.ScriptParameters": "-Name '#{Name}' -ResourceGroupName '#{ResourceGroupName}' -VMName '#{VMName}' -Location '#{Location}' -StorageAccountName '#{StorageAccountName}' -StorageAccountKey '#{StorageAccountKey}'",
            "ResourceGroupName": "#{ResourceGroup}",
            "VMName": "#{VMName}",
            "Name": "Sysprep",
            "Location": "#{AzureRegion}",
            "StorageAccountName": "#{StorageAccountName}",
            "StorageAccountKey": "#{StorageAccountKey}",
            "Octopus.Action.Template.Id": "ActionTemplates-9",
            "Octopus.Action.Template.Version": "4"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "Azure Automation"
      }
    },
    {
      "Id": "489af284-4fdc-4948-9e1a-a148ca66400e",
      "Name": "Convert VM to Image",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "c88ec6e4-581d-4e89-a6ad-729d09d9bd67",
          "Name": "Convert VM to Image",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Script.ScriptFileName": "Convert-VMtoImage.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Compute",
            "Octopus.Action.Script.ScriptParameters": "-ResourceGroupName '#{ResourceGroup}'  -VMName '#{VMName}'"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "Azure Automation"
      }
    },
    {
      "Id": "7a4d23f6-fb9b-4cca-b6bb-06280993ff16",
      "Name": "Copy VM Image",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "cb18f90f-18c9-4b27-8e02-95d5755333eb",
          "Name": "Copy VM Image",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Script.ScriptFileName": "Copy-VHDToStorageAccount.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Storage",
            "Octopus.Action.Script.ScriptParameters": "-VHDUri '#{Octopus.Action[Convert VM to Image].Output.ImageUri}' -SrcResourceGroupName '#{ResourceGroup}' -DstResourceGroupName '#{InfraRg}' -DstStorageAccount '#{StorageAccountName}'  -DstBlob '#{VMName}.image.vhd'"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "ARM Provisioning"
      }
    },
    {
      "Id": "388c9513-38a8-48e0-9904-a621b5a4a605",
      "Name": "Remove Resource Group",
      "Condition": "Success",
      "StartTrigger": "StartAfterPrevious",
      "RequiresPackagesToBeAcquired": false,
      "Actions": [
        {
          "Id": "b0b101df-6505-4517-a7cb-3242075aed6c",
          "Name": "Remove Resource Group",
          "ActionType": "Octopus.AzurePowerShell",
          "IsDisabled": false,
          "Environments": [],
          "ExcludedEnvironments": [],
          "Channels": [],
          "TenantTags": [],
          "Properties": {
            "Octopus.Action.Package.FeedId": "feeds-builtin",
            "Octopus.Action.Azure.AccountId": "azureserviceprincipal-microsoft-azure-service-principal",
            "Octopus.Action.Script.ScriptSource": "Package",
            "Octopus.Action.Script.ScriptFileName": "Remove-ResourceGroup.ps1",
            "Octopus.Action.Package.PackageId": "AutomationStackScripts.Resources",
            "Octopus.Action.Script.ScriptParameters": "-ResourceGroupName '#{ResourceGroupName}' -PassThru '#{PassThru}'",
            "ResourceGroupName": "#{ResourceGroup}",
            "Octopus.Action.Template.Id": "ActionTemplates-12",
            "Octopus.Action.Template.Version": "2"
          }
        }
      ],
      "Properties": {
        "Octopus.Action.TargetRoles": "ARM Provisioning"
      }
    }
  ],
  "RelatedDocumentIds": []
}